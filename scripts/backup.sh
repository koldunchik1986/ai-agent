#!/bin/bash

# ===================================================================
# –°–ö–†–ò–ü–¢ –†–ï–ó–ï–†–í–ù–û–ì–û –ö–û–ü–ò–†–û–í–ê–ù–ò–Ø AI-–ê–°–°–ò–°–¢–ï–ù–¢–ê
# ===================================================================
# –°–æ–∑–¥–∞–µ—Ç –ø–æ–ª–Ω—É—é —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö:
# - –î–æ–∫—É–º–µ–Ω—Ç—ã
# - –í–µ–∫—Ç–æ—Ä–Ω–∞—è –±–∞–∑–∞
# - –î–æ–æ–±—É—á–µ–Ω–Ω—ã–µ –º–æ–¥–µ–ª–∏
# - –ù–∞—Å—Ç—Ä–æ–π–∫–∏
# - –ö—ç—à

set -e

# –¶–≤–µ—Ç–∞
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

log() {
    echo -e "${GREEN}[BACKUP]${NC} $1"
}

warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

# ===================================================================
# –ù–ê–°–¢–†–û–ô–ö–ò
# ===================================================================
BACKUP_DIR="backups"
DATA_DIR="${AGENT_HOME:-./data}"
TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
BACKUP_NAME="ai_assistant_backup_${TIMESTAMP}"
BACKUP_PATH="${BACKUP_DIR}/${BACKUP_NAME}"

# ===================================================================
# –ü–†–û–í–ï–†–ö–ò
# ===================================================================
if [ ! -d "$DATA_DIR" ]; then
    error "–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–∞–Ω–Ω—ã—Ö –Ω–µ –Ω–∞–π–¥–µ–Ω–∞: $DATA_DIR"
fi

# –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–ª—è –±—ç–∫–∞–ø–æ–≤
mkdir -p "$BACKUP_DIR"

# ===================================================================
# –°–û–ó–î–ê–ù–ò–ï –ë–≠–ö–ê–ü–ê
# ===================================================================
log "–°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏: $BACKUP_NAME"

# –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –±—ç–∫–∞–ø–∞
TEMP_DIR=$(mktemp -d)
trap "rm -rf $TEMP_DIR" EXIT

log "–ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö..."

# –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º
rsync -av --progress \
    --exclude="*.tmp" \
    --exclude="*.lock" \
    --exclude="*.log" \
    "$DATA_DIR/" "$TEMP_DIR/"

# –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–µ—Ç–∞–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
log "–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–µ—Ç–∞–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏..."
cat > "$TEMP_DIR/backup_info.json" << EOF
{
    "timestamp": "$(date -Iseconds)",
    "version": "1.0.0",
    "data_size": "$(du -sh $TEMP_DIR | cut -f1)",
    "contents": {
        "documents": "$(find $TEMP_DIR/documents -type f 2>/dev/null | wc -l)",
        "models": "$(find $TEMP_DIR/models -type f 2>/dev/null | wc -l)",
        "chroma": "$(find $TEMP_DIR/chroma -type f 2>/dev/null | wc -l)",
        "cache": "$(find $TEMP_DIR/cache -type f 2>/dev/null | wc -l)"
    }
}
EOF

# –ê—Ä—Ö–∏–≤–∞—Ü–∏—è
log "–ê—Ä—Ö–∏–≤–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö..."
cd "$(dirname "$TEMP_DIR")"
tar -czf "${BACKUP_PATH}.tar.gz" "$(basename "$TEMP_DIR")"

# ===================================================================
# –ü–†–û–í–ï–†–ö–ê –¶–ï–õ–û–°–¢–ù–û–°–¢–ò
# ===================================================================
log "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ –∞—Ä—Ö–∏–≤–∞..."
if tar -tzf "${BACKUP_PATH}.tar.gz" > /dev/null 2>&1; then
    log "‚úÖ –ê—Ä—Ö–∏–≤ —Ü–µ–ª–æ—Å—Ç–µ–Ω"
else
    warn "‚ùå –ê—Ä—Ö–∏–≤ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω!"
fi

# ===================================================================
# –£–î–ê–õ–ï–ù–ò–ï –°–¢–ê–†–´–• –ë–≠–ö–ê–ü–û–í (–°–¢–ê–†–®–ï 30 –î–ù–ï–ô)
# ===================================================================
log "–û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –±—ç–∫–∞–ø–æ–≤..."
find "$BACKUP_DIR" -name "*.tar.gz" -type f -mtime +30 -delete

# ===================================================================
# –ò–¢–û–ì–ò
# ===================================================================
BACKUP_SIZE=$(du -sh "${BACKUP_PATH}.tar.gz" | cut -f1)
log "‚úÖ –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è —Å–æ–∑–¥–∞–Ω–∞:"
log "   üìÅ –ü—É—Ç—å: ${BACKUP_PATH}.tar.gz"
log "   üìä –†–∞–∑–º–µ—Ä: $BACKUP_SIZE"
log "   üïê –í—Ä–µ–º—è: $(date)"

# –í—ã–≤–æ–¥ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏
echo -e "${BLUE}"
echo "–î–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:"
echo "  tar -xzf ${BACKUP_PATH}.tar.gz -C /tmp/"
echo "  cp -r /tmp/${BACKUP_NAME}/* \$AGENT_HOME/"
echo -e "${NC}"

exit 0