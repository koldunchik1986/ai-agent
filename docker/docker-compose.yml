# ===================================================================
# DOCKER COMPOSE ДЛЯ AI-АССИСТЕНТА
# ===================================================================
# Оптимизации для 8GB VRAM:
# - Лимиты памяти (12GB RAM, 16GB swap)
# - Явное назначение GPU 0
# - Environment variables для оптимизации
# - Health checks
# - Restart policies

version: '3.8'

services:
  ai-assistant:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    
    # Имя контейнера для удобства
    container_name: ai-assistant-p104
    
    # ✅ Использование NVIDIA runtime (критично для GPU)
    runtime: nvidia
    
    # ===================================================================
    # РЕСУРСЫ И ЛИМИТЫ (8GB GPU ОПТИМИЗАЦИЯ)
    # ===================================================================
    deploy:
      resources:
        limits:
          # Ограничение RAM для контейнера (оставляем запас для системы)
          memory: 12G
          cpus: '4'
        reservations:
          devices:
            - driver: nvidia
              # ✅ ЯВНОЕ НАЗНАЧЕНИЕ GPU 0 (предотвращает ошибки)
              count: 1
              device_ids: ['0']
              capabilities: [gpu]
    
    # ===================================================================
    # ПЕРЕМЕННЫЕ ОКРУЖЕНИЯ
    # ===================================================================
    environment:
      # Указание GPU
      - NVIDIA_VISIBLE_DEVICES=0
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility
      - CUDA_VISIBLE_DEVICES=0
      
      # Пути внутри контейнера
      - AGENT_HOME=/app/data
      - MODEL_CACHE_PATH=/app/data/models
      - DOCUMENT_PATH=/app/data/documents
      - CACHE_PATH=/app/data/cache
      
      # ✅ ОПТИМИЗАЦИИ ПАМЯТИ (КРИТИЧНО)
      - PYTORCH_CUDA_ALLOC_CONF=max_split_size_mb:128,garbage_collection_threshold:0.6
      - OMP_NUM_THREADS=1
      - TOKENIZERS_PARALLELISM=false
      
      # Настройки для IDE интеграции
      - VSCODE_PROJECTS_PATH=/app/data/vscode_projects
    
    # ===================================================================
    # VOLUMES (МАППИНГ ДИРЕКТОРИЙ)
    # ===================================================================
    volumes:
      # Основная директория с данными (кэш, модели, документы)
      - ../data:/app/data
      
      # Монтируем src для hot-reload при разработке
      - ../src:/app/src
      
      # Опционально: монтируем директории проектов
      # - /path/to/your/projects:/workspace/projects
    
    # ===================================================================
    # ПОРТЫ (ЕСЛИ НУЖЕН WEB-ИНТЕРФЕЙС В БУДУЩЕМ)
    # ===================================================================
    ports:
      - "8000:8000"  # Потенциальный API порт
    
    # ===================================================================
    # ПЕРЕЗАПУСК И ЗАВИСИМОСТИ
    # ===================================================================
    # Автоматический перезапуск при сбое
    restart: unless-stopped
    
    # Health check (проверка работы)
    healthcheck:
      test: ["CMD", "python3.11", "-c", "import torch; exit(0 if torch.cuda.is_available() else 1)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    
    # ===================================================================
    # СЕТЕВЫЕ НАСТРОЙКИ
    # ===================================================================
    networks:
      - ai-network
    
    # ===================================================================
    # ЛОГИРОВАНИЕ
    # ===================================================================
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

# ===================================================================
# СЕТЬ
# ===================================================================
networks:
  ai-network:
    driver: bridge